lookups = {
    "degC":["°C", "celcius", "degree Celsius", "degcelsius", "degC"],
    "degF":["°F", "fahrenheit", "degfahrenheit", "degF", "degfahrenheit"],
    "degK":["°K", "kelvin", "degK", "tempK"],
    "degR":["°R", "R", "Rankine", "°Ra", "degR"],

    "mm":["mm", "millimeter", "milli-meter"],
    "cm":["cm", "centi-meter", "centi", "centimeter"],
    "m":["m", "meter", "metre"],
    "km":["km", "kilometer"],
    "in":["in", "inch"],
    "ft":["ft", "feet", "foot"],
    "fathom":["fathom", ],
    "mi":["mi", "miles", "mile"],

    "ns":["ns"],
    "ms":["ms","millisecond"],
    "s":["s"],
    "min":["min"],
    "hour":["h","hour"],
    "day":["day", "d"],
    "week":["week"],
    "month":["month"],
    "year":["year"],

    "Hz":["Hz"],
    "mHz":["mHz"],
    "kHz":["kHz"],
    "MHz":["MHz"],
    "GHz":["GHz"],
    "THz":["THz"],
    "rpm":["rpm"],
    "deg/s":["deg/s"],
    "rad/s":["radian/s", "rad/s"],

    "mm/s":["mm/s", "millimeter/s", "milli-meter/s"],
    "cm/s":["cm/s", "centi-meter/s", "centi/s", "centimeter/s"],
    "m/s":["m/s", "meter/s"],
    "m/h":["m/h", "meter/h"],
    "in/s":["in/s", "inch/s"],
    "ft/s":["ft/s", "feet/s", "foot/s"],
    "mi/h":["mi/h", "miles/h", "mile/h"],
    "knot":["knot"],

    "mm^2":["mm^2", "mm2", "millimeter-2", "millimeter2", "mm square" ],
    "cm^2":["cm^2", "cm2", "centimeter-2", "centimeter2", "cm square"],
    "m^2":["m^2", "m2","meter2", "meter square"],
    "ha":["ha", "hactare"],
    "km^2":["km^2", "km2", "kilometer2", "kilometer square"],
    "in^2":["in^2", "in2", "inch2", "inch^2", "inch-square", "inch square"],
    "ft^2":["ft^2" , "ft2", "feet2", "feetsquare"],
    "acre":["ac", "acre"],
    "mi^2":["mi^2", "miles square", "miles2", "miles^2"],

    "mm^3":["mm^3", "mm3", "millimeter-3", "millimeter3", "mm cube" ],
    "cm^3":["cm^3", "cm3", "centimeter-3", "centimeter3", "cm cube"],
    "m^3":["m^3", "m3","meter3", "meter cube"],
    "km^3":["km^3", "km3", "kilometer3", "kilometer cube"],
    "in^3":["in^3", "in3", "inch3", "inch^3", "inch-cube", "inch cube"],
    "ft^3":["ft^3" , "ft3", "feet3", "feetcube"],
    "mi^3":["mi^3", "miles cube", "miles3", "miles^3"],
    "ml":["ml", "milliliter"],
    "l":["l", "liter"],
    "kl":["kl", "kiloliter"],
    "tsp":["tsp", "teaspoon"],
    "in^3":["in^3"],
    "cup":["cup"],
    "qt":["qt"],
    "gal":["gal","gallon"],
    "yd^3":["yd^3","yd3"],

    # "mcg":["mcg"],
    "mg":["mg"],
    "g":["g"],
    "kg":["kg"],
    "oz":["oz"],
    "lb":["lb"],
    "mt":["mt"],
    "t":["t"],

    "mm^3/s":["mm^3/s", "mm3/s", "millimeter-3/s", "millimeter3/s", "mm cube/s" ],
    "cm^3/s":["cm^3/s", "cm3/s", "centimeter-3/s", "centimeter3/s", "cm cube/s"],
    "m^3/s":["m^3/s", "m3/s","meter3/s", "meter cube/s"],
    "ml/s":["ml/s", "milliliter/s"],
    "kl/s":["kl/s", "kl/s", "kiloliter/s", "kiloliter/s"],
    "kl/min":["kl/min", "kiloliter/min", "kiloliter/min"],
    "kl/h":["kl/h", "kl/h", "kiloliter/h", "kiloliter/h"],
    "km^3/h":["km^3/h", "km3/h", "kilometer3/h", "kilometer cube/h"],
    "cl/s":["cl/s", "cl/s", "cl/s", "cl/s"],
    "dl/s":["dl/s"],
    "l/s":["l/s", "liter/s"],
    "l/min":["l/min", "liter/min"],
    "l/h":["l/h", "liter/h"],
    "ft^3/s":["ft^3/s" , "ft3/s", "feet3/s", "feetcube/s"],
    "mi^3/s":["mi^3/s", "miles cube/s", "miles3/s", "miles^3/s"],
    "tsp/s":["tsp/s", "teaspoon/s"],
    "in^3/s":["in^3/s"],
    "cup/s":["cup/s"],
    "qt/s":["qt/s"],
    "gal/s":["gal/s","gallon/s"],
    "gal/min":["gal/min","gallon/min"],
    "yd^3/s":["yd^3/s","yd3/s"],

    "s/m":["s/m"],
    "min/m":["min/m"],
    "s/ft":["s/ft"],
    "min/km":["min/km"],

    "Pa":["Pa"],
    "hPa":["hPa"],
    "kPa":["kPa"],
    "MPa":["MPa"],
    "bar":["bar"],
    "psi":["psi"],
    "ksi":["ksi"],

    "bit":["bit"],
    "byte":["byte"],
    "B":["B"],
    "kB":["kB"],
    "MB":["MB"],
    "GB":["GB"],
    "TB":["TB"],

    "V":["V"],
    "mV":["mV"],
    "kV":["kV"],

    "A":["A"],
    "mA":["mA"],
    "kA":["kA"],

    "W":["W"],
    "mW":["mW"],
    "kW":["kW"],
    "MW":["MW"],
    "GW":["GW"],

    "Wh":["Wh"],
    "mWh":["mWh"],
    "MWh":["MWh"],
    "GWh":["GWh"],
    "J":["J"],
    "kJ":["kJ"],

    "deg":["deg"],
    "rad":["radian", "rad"],
    "arcmin":["arcmin"],
    "arcsec":["arcsec"],

    "C":["C"],
    "mC":["mC"],
    "μC":["μC"],
    "nC":["nC"],
    "pC":["pC"],

    "N":["N"],
    "kN":["kN"],
    "lbf":["lbf"],

    "gravity":["gravity", "gravity"],
    "m/s^2":["m/s^2"]
     }

import asyncio
import json
import csv
import istsos
from istsos.entity.rest.response import Response
from istsos.actions.action import CompositeAction
from pint import UnitRegistry, set_application_registry
ureg = UnitRegistry(autoconvert_offset_to_baseunit = True)
set_application_registry(ureg)
Q_ = ureg.Quantity



class UnitConvPint(CompositeAction):

    @asyncio.coroutine
    def before(self, request):
        """
        Request example: {
            "action": "UNIT_CON_POST",
            "data": {
                "offerings": ["belin","belin"],
                "observedProperties": [
                    "urn:ogc:def:parameter:x-istsos:1.0:temperature"
                ],
                "temporal": {
                    "reference": "om:phenomenonTime",
                    "fes": "during",
                    "period": [
                        "2015-05-03T16:30:00.000000+0200",
                        "2015-06-03T16:30:00.000000+0200"
                    ]
                },
                "responseFormat": "application/json;subtype='array'"
            },
            "in_unit":"°F"
        }
        """
        yield from self.add_plugin("unit_con_pint", "UnitConversionPint")

    @asyncio.coroutine
    def after(self, request):
        headers = [{
            "type": "datetime",
            "name": "Phenomenon Time",
            "column": "e"
        }]
        # from_unit=request['json']['data']['from_unit']
        from_unit=request['offerings'][0]['observable_properties'][0]['uom']
        # from_unit=yield from self.findLookUp(from_unit)
        from_unit="degK"
        # to_unit=request['json']['data']['to_unit']
        ConvertUnit=[]
        To_unit=''
        if request.get_filter("in_unit") is not None:
            To_unit=request.get_filter("in_unit")
            To_unit=yield from self.findLookUp(To_unit)
            recs=request['observations'].copy()
            if request.get_filter("operation") is not None:
                if 'unit' in request.get_filter("operation"):
                    unit=yield from self.findLookUp(request.get_filter("operation")['unit'])
                    if 'qty' in request.get_filter("operation"):
                        qty=request.get_filter("operation")['qty']
                        if 'type' in request.get_filter("operation"):
                            if request.get_filter("operation")['type']=='add':
                                add=qty
                                if qty=='':
                                    add=0
                                for rec in recs:
                                    change=str(rec[1])+"*"+from_unit+"add"+str(add)+"*"+unit
                                    src, dst = change.split('add')
                                    change1=Q_(src)+Q_(dst)
                                    change1=Q_(change1).to(To_unit)
                                    change2=change1.magnitude
                                    ConvertUnit.append([rec[0],str(change2)])
                                conversion_uom=To_unit
                            elif request.get_filter("operation")['type']=='sub':
                                sub=qty
                                if qty=='':
                                    sub=0
                                for rec in recs:
                                    change=str(rec[1])+"*"+from_unit+"sub"+str(sub)+"*"+unit
                                    src, dst = change.split('sub')
                                    change1=Q_(src)-Q_(dst)
                                    change1=Q_(change1).to(To_unit)
                                    change2=change1.magnitude
                                    ConvertUnit.append([rec[0],str(change2)])
                                conversion_uom=To_unit
                            elif request.get_filter("operation")['type']=='mul':
                                mul=qty
                                if qty=='':
                                    mul=1
                                for rec in recs:
                                    change=str(rec[1])+"*"+from_unit+"mul"+str(mul)+"*"+unit
                                    src, dst = change.split('mul')
                                    change1=Q_(src)*Q_(dst)
                                    conversion_uom="""%s*%s"""%(To_unit,unit)
                                    change1=Q_(change1).to(conversion_uom)
                                    change2=change1.magnitude
                                    ConvertUnit.append([rec[0],str(change2)])
                            elif request.get_filter("operation")['type']=='div':
                                mul=qty
                                if qty=='':
                                    mul=1
                                for rec in recs:
                                    change=str(rec[1])+"*"+from_unit+"mul"+str(mul)+"*"+unit
                                    src, dst = change.split('mul')
                                    change1=Q_(src)/Q_(dst)
                                    conversion_uom="""%s/%s"""%(To_unit,unit)
                                    change1=Q_(change1).to(conversion_uom)
                                    change2=change1.magnitude
                                    ConvertUnit.append([rec[0],str(change2)])
                else:
                    if 'qty' in request.get_filter("operation"):
                        qty=request.get_filter("operation")['qty']
                        if 'type' in request.get_filter("operation"):
                            if request.get_filter("operation")['type']=='add':
                                add=qty
                                if qty=='':
                                    add=0
                                for rec in recs:
                                    change=str(rec[1])+"*"+from_unit+"add"+str(add)+"*"+from_unit
                                    src, dst = change.split('add')
                                    change1=Q_(src)+Q_(dst)
                                    change1=Q_(change1).to(To_unit)
                                    change2=change1.magnitude
                                    ConvertUnit.append([rec[0],str(change2)])
                                conversion_uom=To_unit
                            elif request.get_filter("operation")['type']=='sub':
                                sub=qty
                                if qty=='':
                                    sub=0
                                for rec in recs:
                                    change=str(rec[1])+"*"+from_unit+"sub"+str(sub)+"*"+from_unit
                                    src, dst = change.split('sub')
                                    change1=Q_(src)-Q_(dst)
                                    change1=Q_(change1).to(To_unit)
                                    change2=change1.magnitude
                                    ConvertUnit.append([rec[0],str(change2)])
                                conversion_uom=To_unit
                            elif request.get_filter("operation")['type']=='mul':
                                mul=qty
                                if qty=='':
                                    mul=1
                                for rec in recs:
                                    change=str(rec[1])+"*"+from_unit+"mul"+str(mul)+"*"+from_unit
                                    src, dst = change.split('mul')
                                    change1=Q_(src)*Q_(dst)
                                    conversion_uom="""%s*%s"""%(To_unit,from_unit)
                                    change1=Q_(change1).to(conversion_uom)
                                    change2=change1.magnitude
                                    ConvertUnit.append([rec[0],str(change2)])
                            elif request.get_filter("operation")['type']=='div':
                                mul=qty
                                if qty=='':
                                    mul=1
                                for rec in recs:
                                    change=str(rec[1])+"*"+from_unit+"mul"+str(mul)+"*"+from_unit
                                    src, dst = change.split('mul')
                                    change1=Q_(src)/Q_(dst)
                                    conversion_uom="""%s/%s"""%(To_unit,from_unit)
                                    change1=Q_(change1).to(conversion_uom)
                                    change2=change1.magnitude
                                    ConvertUnit.append([rec[0],str(change2)])
            else:
                for rec in recs:
                    change=str(rec[1])+"*"+from_unit+"to"+To_unit
                    src, dst = change.split('to')
                    change1=Q_(src).to(dst)
                    change2=change1.magnitude
                    ConvertUnit.append([rec[0],str(change2)])
                    conversion_uom=To_unit
            # for rec in recs:
            #     # change=rec[1]*ureg.kilometers
            #     # change1=change.to(ureg.meter)
            #     # change2=change1.magnitude
            #     change=str(rec[1])+"*"+from_unit+"to"+to_unit
            #     # change=Q_(str(rec[1]), ureg.degC).to(ureg.kelvin)
            #     # change=str(rec[1])+"*degC"+"to"+"degF"
            #     # change=str(rec[1])+"*ureg.degC"+"to"+"ureg.degF"
            #     # change=rec[1]*ureg.degC
            #     # change=str(rec[1])+"* kelvin to degF"
            #     src, dst = change.split('to')
            #     change1=Q_(src).to(dst)
            #     # home = Q_(rec[1], ureg.degC)
            #     # change1=home.to('degF')
            #     # change1=Q_(rec[1], ureg.degC).to(ureg.kelvin).magnitude
            #     change2=change1.magnitude
            #     # print(change2)
            #     # print(change1)
            #     ConvertUnit.append([rec[0],str(change2)])
            headers.append({
                "type": request["headers"][1]["type"],
                "name": request["headers"][1]["name"],
                "definition": request["headers"][1]["definition"],
                "offering": request["headers"][1]["offering"],
                "uom": conversion_uom
            })
            request['response'] = Response(
                json_source=Response.get_template({
                    "data": ConvertUnit,
                    "headers": headers
                })
            )
            yield from self.__download_file(request, ConvertUnit, headers )
        else:
            # print('nothing happened')
            request['response'] = Response(
                json_source=Response.get_template({
                    "data": request['observations'],
                    "headers": request['headers']
                })
            )


    @asyncio.coroutine
    def findLookUp(self, unit):
        for key, value in lookups.items():
            if str(unit).lower() in (n.lower() for n in value):
                return key
        return(unit)

    @asyncio.coroutine
    def __download_csv_from_json(self, request, data, headers=None):
        if request.get_filter("download_file") is not None:
            if 'file_name' in request.get_filter("download_file"):
                file_name=request.get_filter("download_file")['file_name']
            else:
                file_name=request.get_filter("offerings")

            if 'location' in request.get_filter("download_file"):
                download_location=request.get_filter("download_file")['location']
            else:
                download_location='istsos/plugins/unit_con_pint/download_file/'

            file_detail = """%s%s.csv""" % (download_location, file_name)
            csvwriter = csv.writer(open(file_detail, "w"))
            if headers is not None:
                csvwriter.writerow(headers)
            count = 0
            for obj in data:
                if count == 0:
                    header = obj.keys()
                    csvwriter.writerow(header)
                    count += 1
                csvwriter.writerow(obj.values())

            debug_detail = """%s.csv download location is %s""" % (file_name, download_location)
            istsos.debug(debug_detail)

    @asyncio.coroutine
    def __download_file(self, request, data, headers=None):
        if request.get_filter("download_file") is not None:
            if 'file_name' in request.get_filter("download_file"):
                file_name=request.get_filter("download_file")['file_name']
            else:
                file_name=request.get_filter("offerings")

            if 'location' in request.get_filter("download_file"):
                download_location=request.get_filter("download_file")['location']
            else:
                download_location='istsos/plugins/unit_con_pint/download_file/'

            file_detail = """%s%s.csv""" % (download_location, file_name)
            f = csv.writer(open(file_detail, "w"))
            if headers is not None:
                f.writerow(headers)
            for x in data:
                f.writerow(x)
            debug_detail = """%s.csv download location is %s""" % (file_name, download_location)
            istsos.debug(debug_detail)